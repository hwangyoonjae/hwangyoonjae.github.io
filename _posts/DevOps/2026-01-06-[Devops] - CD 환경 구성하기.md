---
layout: post
title: "CD 환경 구성하기"
date: 2026-01-06
categories: DevOps 
tags: [CI, CD]
image: /assets/img/post-title/devops.jpg
---

> CD 환경 구성은 ArgoCD를 통해서 배포하며, Gitlab Webhook 이벤트를 통해 
{: .prompt-info}

* * *

## 1. CD 환경 구성하기 :
- 아래 URL 접속하여 CD 환경을 구성합니다.
> * [ArgoCD 설치하기](https://hwangyoonjae.github.io/posts/Helm-Helm-Chart%EB%A5%BC-%ED%86%B5%ED%95%B4-ArgoCD-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0/ "ArgoCD 설치하기")
> * [ArgoCD Webhook 설정하기](https://hwangyoonjae.github.io/posts/ArgoCD-ArgoCD-Webhook-%EC%84%A4%EC%A0%95/ "ArgoCD Webhook 설정하기")
> * [ArgoCD Blue-Green 배포하기](https://hwangyoonjae.github.io/posts/ArgoCD-ArgoCD-Blue-Green-%EB%B0%B0%ED%8F%AC/ "ArgoCD Blue-Green 배포하기")
> * [ArgoCD Canary 배포하기](https://hwangyoonjae.github.io/posts/ArgoCD-ArgoCD-Carany-%EB%B0%B0%ED%8F%AC/ "ArgoCD Canary 배포하기")

> 필자는 ArgoCD 설치 시 Helm Chart를 이용하여 진행하였고, 배포 방식은 Blue-Green으로 배포 하였습니다.
{: .prompt-warning}

* * *

## 2. Gitlab Repo 생성 및 파일 구조 생성하기 :
### 2.1 Gitlab CD 파일 구조 :

- 파일 구조는 아래와 같습니다.

```bash
DEV-MANIFEST/
├── argocd/
│   └── apps
│       └── app-dev.yaml
│       └── app-prod.yaml
│   └── root-app.yaml
├── base/
│   └── deployment.yaml
│   └── ingress.yaml
│   └── kustomization.yaml
│   └── service.yaml
├── overlays
│   └── dev
│       └── kustomization.yaml
│   └── prod
│       └── kustomization.yaml
```

* * *

### 2.2 Gitlab CD 파일 상세 내용 :

- 애플리케이션 Deployment 정의 파일을 생성합니다.

```yaml
# base/rollout.yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: dev-test
  labels:
    app: dev-test
spec:
  replicas: 1
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app: dev-test
  template:
    metadata:
      labels:
        app: dev-test
    spec:
      containers:
        - name: dev-test
          image: harbor.test.com/pipeline/dev-test:latest # ArgoCD에서 태그 변경용
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080

          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10

          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 20
  strategy:
    blueGreen:
      activeService: dev-test-active
      previewService: dev-test-preview

      # 자동승격
      autoPromotionEnabled: true
      scaleDownDelaySeconds: 1800
      scaleDownDelayRevisionLimit: 1   
      prePromotionAnalysis:   # 승격 전에 분석(헬스체크) 통과해야만 트래픽 전환
        templates:
          - templateName: http-200-check
        args:
          - name: url
            value: http://dev-test-active.dev-test.svc.cluster.local
```

* * *

- ingress 리소스 정의 파일을 생성합니다.

```yaml
# base/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dev-test
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: dev-test.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: dev-test-active
                port:
                  number: 80
```

* * *

```yaml
# base/ingress-preview.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: dev-test-preview
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
    - host: dev-test-preview.test.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: dev-test-preview
                port:
                  number: 80
```

* * *

- Rollout 도중 또는 전환 후에 자동으로 Health Check를 하여 성공/실패 확인하는 파일을 생성합니다.

```yaml
# base/analysis-template.yaml
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: http-200-check
  annotations:
    argocd.argoproj.io/sync-wave: "-1"
spec:
  args:
    - name: url
  metrics:
    - name: http-ok
      interval: 10s             # 10초마다
      count: 3                  # 3회 시도
      failureLimit: 1           # 1번이라도 실패하면 Fail
      provider:
        job:
          spec:
            ttlSecondsAfterFinished: 30   # ← Job/Pod 생성 완료 30초 후 Job/Pod 자동 삭제
            backoffLimit: 0
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: curl
                    image: harbor.test.com/pipeline/curl:8.17.0
                    command: ["/bin/sh","-c"]
                    args:
                      - |
                        set -e
                        CODE=$(curl -m 7 -s -o /dev/null -w "%{http_code}" "")
                        echo "HTTP ${CODE}"
                        [ "$CODE" -eq 200 ]
                    # 자동 승격 실패를 위한 테스트
                    # args:
                    #   - |
                    #     echo "Forcing failure"
                    #     exit 1
```

* * *

- Base 리소스 묶음 정의 파일을 생성합니다.

```yaml
# base/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - rollout.yaml
  - service-active.yaml
  - service-preview.yaml
  - ingress.yaml
  - ingress-preview.yaml
  - analysis-template.yaml
```

* * *

- Service 리소스 정의 파일을 생성합니다.

```yaml
# base/service-active.yaml
apiVersion: v1
kind: Service
metadata:
  name: dev-test-active
  labels:
    app: dev-test
spec:
  type: ClusterIP
  selector:
    app: dev-test
  ports:
    - name: http
      port: 80
      targetPort: 8080
```

```yaml
# base/service-preview.yaml
apiVersion: v1
kind: Service
metadata:
  name: dev-test-preview
  labels:
    app: dev-test
spec:
  type: ClusterIP
  selector:
    app: dev-test
  ports:
    - name: http
      port: 80
      targetPort: 8080
```



* * *

- 개발 환경 전용 Kustomize 오버레이 생성합니다.

```yaml
# overlays/dev/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dev
resources:
  - ../../base
images:
  - name: harbor.test.com/pipeline/dev-test
    newTag: latest
```

* * *

- 운영 환경 전용 Kustomize 오버레이 생성합니다.

```yaml
# overlays/prod/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: prod
resources:
  - ../../base
images:
  - name: harbor.test.com/pipeline/dev-test
    newTag: latest
```

* * *

## 3. CD 환경 구성 후 ArgoCD 어플리케이션 생성하기 :

- ArgoCD의 어플리케이션 생성하여 Kubernetes 클러스터의 설정한 상태로 적용하도록 등록한다.

![CD 파이프라인 적용 화면](/assets/img/post/devops/CD%20파이프라인%20적용%20화면.png)

* * *
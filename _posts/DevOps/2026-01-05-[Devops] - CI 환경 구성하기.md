---
layout: post
title: "CI 환경 구성하기"
date: 2026-01-05
categories: DevOps 
tags: [CI, CD]
image: /assets/img/post-title/devops.jpg
---

> CI 환경 구성은 JAVA 소스 빌드하여 컨테이너 이미지 생성 후, 이미지 레포지토리에 업로드 및 이미지 태그명 변경하도록 구성하였습니다.
{: .prompt-info}

* * *

## 1. CI 환경 구성하기 :
- 아래 URL 접속하여 CI 환경을 구성합니다.
> * [Gitlab 설치하기](https://hwangyoonjae.github.io/posts/Helm-Helm-Chart%EB%A5%BC-%ED%86%B5%ED%95%B4-Gitlab-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0/ "Gitlab 설치하기")
> * [Runner 설치하기](https://hwangyoonjae.github.io/posts/Helm-Helm-Chart%EB%A5%BC-%ED%86%B5%ED%95%B4-Gitlab-Runner-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0/ "Runner 설치하기")
> * [Gitlab + Runner 등록하기](https://hwangyoonjae.github.io/posts/Kubernetes-Pod%EB%A1%9C-%EC%84%A4%EC%B9%98%ED%95%9C-Runner-%EB%93%B1%EB%A1%9D%ED%95%98%EA%B8%B0/ "Gitlab + Runner 등록하기")

> 필자는 Gitlab과 Runner 설치 시 Helm Chart를 이용하여 진행하였습니다.
{: .prompt-warning}

* * *

## 2. Gitlab Repo 생성 및 파일 구조 생성하기 :
### 2.1 Gitlab CI 파일 구조 :

- 파일 구조는 아래와 같습니다.

```bash
DEV-TEST/
├── ci/
│   └── settings.xml
├── src/
│   └── main/
│       └── java/
│           └── com/
│               └── example/
│                   └── webdemo/
│                       ├── HelloController.java
│                       └── WebDemoApplication.java
├── .gitlab-ci.yml
├── Dockerfile
├── pom.xml
└── README.md
```

* * *

### 2.2 Gitlab CI 파일 상세 내용 :

- CI/CD 환경에서 Maven 빌드를 수행할 때 사용하는 설정 파일로 주로 폐쇄망 또는 내부 저장소 환경에서 의존성 다운로드를 위해 사용합니다.

```xml
<!-- ci/settings.xml -->
<settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
          xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0 https://maven.apache.org/xsd/settings-1.0.0.xsd">
  <mirrors>
    <mirror>
      <id>nexus</id>
      <name>nexus-mirror</name>
      <url>${NEXUS_MIRROR_URL}</url>
      <mirrorOf>*</mirrorOf>
    </mirror>
  </mirrors>

  <!-- nexus가 인증 필요하면 server도 추가 -->
  <!--
  <servers>
    <server>
      <id>nexus</id>
      <username>${env.NEXUS_USER}</username>
      <password>${env.NEXUS_PASS}</password>
    </server>
  </servers>
  -->
</settings>
```

* * *

- Spring Boot 애플리케이션 실행 진입점 파일과 웹 요청을 처리하는 컨트롤러 클래스 파일을 생성합니다.

```java
// HelloController.java
package com.example.webdemo;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class HelloController {
  @GetMapping("/")
  public String home() {
    return "Hello, CI/CD + Harbor!";
  }
}
```

```java
// WebDemoApplication.java
package com.example.webdemo;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class WebDemoApplication {
  public static void main(String[] args) {
    SpringApplication.run(WebDemoApplication.class, args);
  }
}
```

* * *

- GitLab CI/CD 파이프라인을 정의하는 설정 파일로, 소스 코드 빌드, 테스트, Docker 이미지 생성 및 배포 등의 자동화 작업 흐름을 단계별로 정의합니다.

```yaml
# .gitlab-ci.yml
stages:
  - build
  - manifest

variables:
  IMAGE_NAME: "${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${CI_PROJECT_NAME}"

build-and-push-image:
  stage: build
  image:
    name: "${HARBOR_REGISTRY}/kaniko/executor:debug"
    entrypoint: [""]
  script:
    - |
      RAW_TAG="$(printf "%s" "${CI_COMMIT_MESSAGE:-}" | head -n1)"
      SAFE_TAG="$(echo "$RAW_TAG" \
        | tr '[:upper:]' '[:lower:]' \
        | sed -E 's/[^a-z0-9._-]+/-/g; s/^-+//; s/-+$//; s/\.{2,}/./g' \
        | cut -c1-60)"
      if [ -z "$SAFE_TAG" ] || [ "$SAFE_TAG" = "-" ]; then
        SAFE_TAG="$(date +%Y%m%d-%H%M%S)"
      fi
      echo "$SAFE_TAG" > image_tag.txt
      echo "IMAGE TAG = $SAFE_TAG"

    - mkdir -p /kaniko/.docker
    - |
      cat > /kaniko/.docker/config.json <<EOF
      {
        "auths": {
          "${HARBOR_REGISTRY}": {
            "username": "${HARBOR_USER}",
            "password": "${HARBOR_PASS}"
          }
        }
      }
      EOF

    - mkdir -p /kaniko/ssl/certs
    - echo "$CI_CA_CERT" > /kaniko/ssl/certs/harbor-ca.crt

    - |
      /kaniko/executor \
        --context "${CI_PROJECT_DIR}" \
        --dockerfile "${CI_PROJECT_DIR}/Dockerfile" \
        --destination "${IMAGE_NAME}:$(cat image_tag.txt)" \
        --registry-certificate "${HARBOR_REGISTRY}=/kaniko/ssl/certs/harbor-ca.crt" \
        --build-arg "NEXUS_MIRROR_URL=${NEXUS_MIRROR_URL}" \
        --build-arg "CI_CA_CERT=${CI_CA_CERT}"

  artifacts:
    expire_in: 1 day
    paths:
      - image_tag.txt

update-manifest:
  stage: manifest
  image: "harbor.test.com/pipeline/alpine:3.20"
  needs: ["build-and-push-image"]
  dependencies: ["build-and-push-image"]
  script: |
    set -e
    apk add --no-cache git yq ca-certificates
    update-ca-certificates

    # GitLab 사설 CA 등록 (Harbor CA와 동일하면 CI_CA_CERT 써도 됨)
    mkdir -p /usr/local/share/ca-certificates
    echo "${GITLAB_CA_CERT:-$CI_CA_CERT}" > /usr/local/share/ca-certificates/gitlab-ca.crt
    update-ca-certificates

    # 토큰 주입 확인(토큰 노출 없이)
    [ -n "${MANIFEST_REPO_TOKEN:-}" ] || (echo "MANIFEST_REPO_TOKEN is EMPTY" && exit 1)
    [ -n "${MANIFEST_REPO_USER:-}" ]  || (echo "MANIFEST_REPO_USER is EMPTY"  && exit 1)

    TAG="$(cat image_tag.txt)"
    echo "TAG=${TAG}"

    git config --global user.email "cicd@test.com"
    git config --global user.name "${MANIFEST_REPO_USER}"

    # ✅ Deploy Token 방식 (가장 안정적)
    git clone "https://${MANIFEST_REPO_USER}:${MANIFEST_REPO_TOKEN}@${MANIFEST_REPO_URL}/${MANIFEST_REPO_PATH}.git" manifest-repo
    cd manifest-repo

    FILE="overlays/dev/kustomization.yaml"
    yq -i ".images[0].newTag = \"${TAG}\"" "${FILE}"

    git add "${FILE}"
    if git diff --cached --quiet; then
      echo "No changes"
      exit 0
    fi

    git commit -m "chore: update image tag to ${TAG}"
    git push origin main
```

* * *

- Spring Boot 애플리케이션을 컨테이너 이미지로 빌드하기 위한 설정 파일을 생성합니다.

```bash
# Dockerfile
# ===== Build stage =====
FROM harbor.test.com/java/maven:3.9-eclipse-temurin-17 AS build
WORKDIR /src

# (선택) 사설 CA를 빌드 이미지(JVM)에 신뢰시키기 위해 build-arg로 받음
ARG CI_CA_CERT=""

# 소스/설정 복사
COPY ci/settings.xml /root/.m2/settings.xml
COPY . .

# (선택) JVM truststore에 CA 주입 (Nexus HTTPS가 사설CA인 경우 필요)
RUN if [ -n "$CI_CA_CERT" ]; then \
      echo "$CI_CA_CERT" > /tmp/ci-ca.crt && \
      keytool -importcert -noprompt -alias ci-ca \
        -file /tmp/ci-ca.crt \
        -keystore "$JAVA_HOME/lib/security/cacerts" \
        -storepass changeit ; \
    fi

# Maven 빌드 (settings.xml에서 NEXUS 미러 URL은 env로 받는게 깔끔)
ARG NEXUS_MIRROR_URL=""
ENV NEXUS_MIRROR_URL=$NEXUS_MIRROR_URL

RUN mvn -B -U -DskipTests package

# ===== Runtime stage =====
FROM harbor.test.com/java/eclipse-temurin:17-jre
WORKDIR /app
COPY --from=build /src/target/*.jar /app/app.jar
EXPOSE 8080
ENTRYPOINT ["java","-jar","/app/app.jar"]
```

* * *

- 프로젝트의 기본 정보와 의존성, 빌드 방식을 정의하는 Maven 설정 파일을 작성합니다.

```xml
# pom.xml
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>3.3.6</version>
    <relativePath/>
  </parent>

  <groupId>com.inno</groupId>
  <artifactId>dev-test</artifactId>
  <version>0.0.1-SNAPSHOT</version>

  <properties>
    <java.version>17</java.version>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
    </plugins>
  </build>
</project>
```

* * *

## 3. Gitlab CI/CD Pipeline Variable 설정하기 :

- gitlab pipeline 실행 시 사용하는 변수 값을 저장합니다.

> 변수 저장 경로 : ***CI_REPO > Settings > CI/CD > Variables***
{: .prompt-tip}

|        Key          |  Value  |  설명   |
|:-------------------:|:-------:|:---------------:|
| CI_CA_CERT          | `-----BEGIN CERTIFICATE-----`<br>`MIIFhzCC...`<br>`-----END CERTIFICATE-----` | ROOT_CA.CRT |

| HARBOR_PASS         | qwe1212!Q         | HARBOR_PASSWORD     |
| HARBOR_PROJECT      | pipeline          | HARBOR_PROJECT_NAME |
| HARBOR_REGISTRY     | harbor.test.com   | HARBOR_URL          |
| HARBOR_USER         | admin             | HARBOR_USERNAME     |
| MANIFEST_REPO_PATH  | test/dev-manifest | GITLAB_MANIFEST_REPO_PATH |
| MANIFEST_REPO_TOKEN | glpat-gQ4KNJFzk... | GITLAB_ACCESS_TOKEN |
| MANIFEST_REPO_URL   | gitlab.test.com   | GITLAB_URL          |
| MANIFEST_REPO_USER  | root | GITLAB_USERNAME     |
| NEXUS_MIRROR_URL    | http://nexus.test.com:8081/repository/maven-public/ | NEXUS_REPO_URL |

![CI 파이프라인 환경변수 등록 1](/assets/img/post/devops/CI%20파이프라인%20환경변수%20등록%201.png)
![CI 파이프라인 환경변수 등록 2](/assets/img/post/devops/CI%20파이프라인%20환경변수%20등록%202.png)

* * *

## 4. Pipeline 실행하기 :

- 위 파일 구성 및 환경변수 등록이 완료되었다면, 파이프라인을 실행합니다.

![CI 파이프라인 적용 화면](/assets/img/post/devops/CI%20파이프라인%20적용%20화면.png)

* * *